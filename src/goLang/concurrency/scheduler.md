# –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

–í—ã–¥–µ–ª—è—é—Ç 3 –º–æ–¥–µ–ª–∏ –¥–ª—è –Ω–∞—Ä–µ–∑–∞–Ω–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –Ω–∞ –ø–æ—Ç–æ–∫–∏. 

- **N:1** - –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤ –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –µ–¥–∏–Ω–æ–º –ø–æ—Ç–æ–∫–µ —è–¥—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –∏–º–µ–µ—Ç —Ç–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ, —á—Ç–æ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤, –Ω–æ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏ –º–Ω–æ–≥–æ—è–¥–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º. 

- **1:1** - –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–¥–Ω–∏–º –ø–æ—Ç–æ–∫–æ–º –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ —è–¥—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–µ–¥–ª–µ–Ω–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.

- Go –ø—ã—Ç–∞–µ—Ç—Å—è –≤–∑—è—Ç—å –ª—É—á—à–µ–µ –∏–∑ –æ–±–æ–∏—Ö –º–∏—Ä–æ–≤ —Å –ø–æ–º–æ—â—å—é **–ú:N** –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞. –ü—Ä–∏ —ç—Ç–æ–º –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ Go-—Ä—É—Ç–∏–Ω **M** –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ **N** –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –≠—Ç–∏–º –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –±—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —è–¥—Ä–∞–º–∏ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ. –û—Å–Ω–æ–≤–Ω—ã–º –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–º –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ —è–≤–ª—è–µ—Ç—Å—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –µ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫.  

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ Go –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 3 —Å—É—â–Ω–æ—Å—Ç–∏:

<img src="../../media/go/scheduler_mpg.jpeg" title="" alt="img" data-align="center">

**M Machine**(–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫) thread –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –¢–æ—á–Ω–µ–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ –Ω–∏–º, –≤ go runtime –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –≤–∏–¥–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ç–∞–∫–æ–≥–æ –ø–æ—Ç–æ–∫–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ –≤–æ –º–Ω–æ–≥–æ–º –ø–æ–¥–æ–±–Ω–æ –≤–∞—à–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –ø–æ—Ç–æ–∫–∞–º POSIX. 

- **M** —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã `GOMAXPROCS`).
- –ï—Å–ª–∏ –≥–æ—Ä—É—Ç–∏–Ω–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤ `syscall`, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π **M**.
- System Monitor –∑–∞–≤–µ—Ä—à–∞–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ M —á–µ—Ä–µ–∑ `forcegc` (—á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–ª–∏—Å—å –ª–∏—à–Ω–∏–µ –ø–æ—Ç–æ–∫–∏).

**G Goroutine**(–ö—Ä—É–≥). –û–Ω –≤–∫–ª—é—á–∞–µ—Ç —Å—Ç–µ–∫, —É–∫–∞–∑–∞—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥ –∏ –¥—Ä—É–≥—É—é –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω—ã, —Ç–∞–∫—É—é –∫–∞–∫ –∫–∞–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞ –Ω–µ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. 

**P Processor**(–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞ —è–¥—Ä–µ**. –ú–æ–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ c —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥—å—é –≥–æ—Ä—É—Ç–∏–Ω –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π  **M** c –∫–∞–∫–∏–º-—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º(—Ä–µ–≥–∏—Å—Ç—Ä—ã –∏ —Ç.–¥). 

–í –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ Go –µ—Å—Ç—å –¥–≤–µ —Ä–∞–∑–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

- –≥–ª–æ–±–∞–ª—å–Ω–∞—è (**GRQ**) 

- –ª–æ–∫–∞–ª—å–Ω–∞—è (**LRQ**) - –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç –¥–æ `256` –≥–æ—Ä—É—Ç–∏–Ω (**FIFO**) –æ–¥–Ω–∞–∫–æ, –µ—Å—Ç—å —Ç–∞–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –≥–æ—Ä—É—Ç–∏–Ω–∞, –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø–µ—Ä–≤–æ–π, –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏, –æ–¥–Ω–æ—ç–ª–µ–º–µ–Ω—Ç–Ω—ã–π —Å—Ç—ç–∫ **LIFO**. –≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ, –µ—Å—Ç—å –Ω–µ–Ω—É–ª–µ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —Ç–æ–≥–æ —á—Ç–æ –Ω–∞ **M** –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ–æ—Ç–≤—Ç–µ—Ç—Å–≤—É–µ—Ç —Ç–æ–º—É, —á—Ç–æ –Ω—É–∂–µ–Ω –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ, –ø–æ—ç—Ç–æ–º—É —á–∞—Å—Ç–æ –∏–º–µ–µ—Ç —Å–º–≤—Å–ª –≤—ã–ø–æ–ª–Ω–∏—Ç—å –µ—ë –≤–ø–µ—Ä—ë–¥ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.

–ö–∞–∂–¥–æ–º—É **P** –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è **LRQ**, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ **P**. –≠—Ç–∏ –≥–æ—Ä—É—Ç–∏–Ω—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è –∏ –≤—ã–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ **M**, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –¥–ª—è —ç—Ç–æ–≥–æ **P**. **GRQ** –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –≥–æ—Ä—É—Ç–∏–Ω, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è **P**. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≥–æ—Ä—É—Ç–∏–Ω—ã –∏–∑ **GRQ** –≤ **LRQ**

![img](../../media/go/scheduler_grq_lrq.png)

–ö–∞–∂–¥–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–∞–∂–¥—ã–π 61 —Ç–∞–∫—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞.

```go
runtime.schedule() {
    // only 1/61 of the time, check the global runnable queue for a G.
    // if not found, check the local queue.
    // if not found,
    //     try to steal from other Ps.
    //     if not, check the global runnable queue.
    //     if not found, poll network.
}
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ **P** –±—É–¥–µ—Ç:

- –°—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ–±–æ–ª—å—à–æ–π —à–∞–Ω—Å(**1/61**) –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å **GRQ** –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–æ—Ä—É—Ç–∏–Ω—É—é –æ—Ç—Ç—É–¥–∞

- –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ –∑–∞–ø—É—Å–∫–∞—Ç—å **G** –≤ —Å–≤–æ–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º **LRQ**

- –∑–∞—Ç–µ–º –∏–∑ **LRQ** –¥—Ä—É–≥–∏—Ö **P**. –í–æ—Ä—É–µ—Ç—Å—è `1/2` –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –¥—Ä—É–≥–æ–≥–æ(—Å–ª—É—á–∞–π–Ω–æ–≥–æ) **P** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, `128` –∏–∑ `256` –≤–æ–∑–º–æ–∂–Ω—ã—Ö). –ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –¥–µ—Ç–∞–ª—å: **work-stealing** –≤ Go –Ω–µ –æ—á–µ–Ω—å –∞–≥—Ä–µ—Å—Å–∏–≤–µ–Ω, –ø–æ—ç—Ç–æ–º—É –∏–Ω–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∑–∫–∞ —è–¥–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π.

- –∑–∞—Ç–µ–º –∏–∑ **GRQ**

- –∑–∞—Ç–µ–º –∏–∑ **netpoller**. 

–ï—Å–ª–∏ –≥–æ—Ä—É—Ç–∏–Ω—ã –Ω–µ—Ç, –ø–æ—Ç–æ–∫ –∑–∞—Å—ã–ø–∞–µ—Ç (`park()`), –∞ `System Monitor` –ø–æ–∑–∂–µ –µ–≥–æ —Ä–∞–∑–±—É–¥–∏—Ç.

## Work stealing

 –í –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö, –≤–æ–∑–Ω–∏–∫–ª–∏ –¥–≤–µ –ø–∞—Ä–∞–¥–∏–≥–º—ã –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏: 

- **Work-sharing**: –ö–æ–≥–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏, –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –Ω–∞ –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã, –≤ –Ω–∞–¥–µ–∂–¥–µ, —á—Ç–æ –æ–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –∫ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–µ–º—É –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É.
- **Work-stealing**: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ –∏—â–µ—Ç –ø–æ—Ç–æ–∫–∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤ –∏ "–∫—Ä–∞–¥–µ—Ç" –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö.

–ö–æ–≥–¥–∞ –Ω–æ–≤–∞—è **G** —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è **G** —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≥–æ—Ç–æ–≤–æ–π –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é, –æ–Ω–∞ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å –≥–æ—Ç–æ–≤—ã—Ö –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é –≥–æ—Ä—É—Ç–∏–Ω —Ç–µ–∫—É—â–µ–≥–æ **P**. –ö–æ–≥–¥–∞ **P** –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ **G**, –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã—Ç–∞—â–∏—Ç—å **G** –∏–∑ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏. –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç, **P** –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä (**P**) –∏ –ø—ã—Ç–∞–µ—Ç—Å—è —É–∫—Ä–∞—Å—Ç—å –ø–æ–ª–æ–≤–∏–Ω—É –≥–æ—Ä—É—Ç–∏–Ω –∏–∑ –µ–≥–æ –æ—á–µ—Ä–µ–¥–∏.

## –í—ã—Ç–µ—Å–Ω—è—é—â–∞—è –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å

–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞–ø–æ–º–Ω—é, —á—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –∏ –Ω–µ –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å.

–° –Ω–µ –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π (**–≤—ã—Ç–µ—Å–Ω—è—é—â–µ–π**) –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å—é –º—ã –≤—Å–µ —Å –≤–∞–º–∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –∑–Ω–∞–∫–æ–º—ã –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –û–°. –î–∞–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ, –≤—ã–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Ç–æ–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç–≤—Ä–∏—Å—Ç–∏–∫, –∞ –≤–º–µ—Å—Ç–æ –≤—ã–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∏–Ω–∞—é—Ç –ø–æ–ª—É—á–∞—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏.

–î–ª—è **–∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ** –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥—Ä—É–≥–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Äî –æ–Ω —Å–ø–∏—Ç –ø–æ–∫–∞ –æ–¥–Ω–∞ –∏–∑ –≥–æ—Ä—É—Ç–∏–Ω —è–≤–Ω–æ –Ω–µ —Ä–∞–∑–±—É–¥–∏—Ç –µ–≥–æ —Å –Ω–∞–º–µ–∫–æ–º –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ—Ç–¥–∞—Ç—å —Å–≤–æ–µ –º–µ—Å—Ç–æ –¥—Ä—É–≥–æ–π. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–∞–ª–µ–µ —Å–∞–º —Ä–µ—à–∏—Ç, –Ω–∞–¥–æ –ª–∏ —É–±–∏—Ä–∞—Ç—å –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–µ–∫—É—â—É—é –≥–æ—Ä—É—Ç–∏–Ω—É, –∏ –µ—Å–ª–∏ –¥–∞, –∫–æ–≥–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –µ–µ –º–µ—Å—Ç–æ. –ü—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫ –∏ —Ä–∞–±–æ—Ç–∞–ª –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ GO.

–≤ **GO** 1.14 –∏–∑–º–µ–Ω–∏–ª—Å—è –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –ø—Ä–∏—á–∏–Ω—ã –ø–æ –∫–æ—Ç–æ—Ä—ã–º —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ —Å–¥–µ–ª–∞–Ω—ã. –í–∑–≥–ª—è–Ω–∏—Ç–µ –Ω–∞ –∫–æ–¥:

```go
func main() {
    runtime.GOMAXPROCS(1)
    go func() {
        var u int
        for {
            u -= 2
            if u == 1 {
                break
            }
        }
    }()
    <-time.After(time.Millisecond * 5) // –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ main –≥–æ—Ä—É—Ç–∏–Ω–∞ —Ä–∞–∑–±—É–¥–∏—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –∞ –æ–Ω –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—É—Å—Ç–∏—Ç –≥–æ—Ä—É—Ç–∏–Ω—É —Å —Ü–∏–∫–ª–æ–º

    fmt.Println("go 1.13 has never been here")
}
```

–ï—Å–ª–∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å –≤–µ—Ä—Å–∏–µ–π **GO < 1.14**, —Ç–æ —Å—Ç—Ä–æ—á–∫—É ¬´go 1.13 has never been here¬ª –≤—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ –Ω–µ —É–≤–∏–¥–∏—Ç–µ. –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —ç—Ç–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≥–æ—Ä—É—Ç–∏–Ω–µ —Å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º —Ü–∏–∫–ª–æ–º, –æ–Ω–∞ –≤—Å–µ—Ü–µ–ª–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç P, –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π –≥–æ—Ä—É—Ç–∏–Ω—ã –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∏ –∫–∞–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π, –∞ –∑–Ω–∞—á–∏—Ç –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º—ã –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–∑–±—É–¥–∏–º. –ò —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–π –≤—ã–∑–æ–≤ runtime.Gosched() –¥–∞—Å—Ç –Ω–∞—à–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è.

–í –≤–µ—Ä—Å–∏–∏ –¥–æ 1.12 runtime Gosched –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **safe-points** –º–µ—Å—Ç–∞, –≥–¥–µ —Ç–æ—á–Ω–æ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –±–µ–∑ –±–æ—è–∑–Ω–∏, —á—Ç–æ –º—ã –ø–æ–ø–∞–¥–µ–º –≤ –∞—Ç–æ–º–∞—Ä–Ω—É—é –¥–ª—è GC —Å–µ–∫—Ü–∏—é –∫–æ–¥–∞. –ö–∞–∫ –º—ã —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª–∏, –¥–∞–Ω–Ω—ã–µ safe-points —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –≤ –ø—Ä–æ–ª–æ–≥–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–æ –¥–∞–ª–µ–∫–æ –Ω–µ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –∑–∞–º–µ—Ç—å—Ç–µ). –ï—Å–ª–∏ –≤—ã —Ä–∞–∑–±–∏—Ä–∞–ª–∏ go-—à–Ω—ã–π –∞—Å—Å–µ–º–±–ª–µ—Ä, —Ç–æ –º–æ–≥–ª–∏ –±—ã –≤–æ–∑—Ä–∞–∑–∏—Ç—å ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –æ—á–µ–≤–∏–¥–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Ç–∞–º –Ω–µ –≤–∏–¥–Ω–æ. –î–∞ —ç—Ç–æ —Ç–∞–∫, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ —Ç–∞–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤—ã–∑–æ–≤–∞ **runtime.morestack**, –∞ –µ—Å–ª–∏ –∑–∞–≥–ª—è–Ω—É—Ç—å –≤–Ω—É—Ç—Ä—å —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–æ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—Å—è –≤—ã–∑–æ–≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞. 



### Sysmon

–ö–æ–≥–¥–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –¥–µ–ª–∞–µ—Ç `syscall`, **M** –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è. –ß—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã, **P** –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç—Å—è (`handoff`), –∏ `System Monitor` –≤—ã–¥–µ–ª—è–µ—Ç –Ω–æ–≤—ã–π **M** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç—Ç–∏–º **P**.

–ö–æ–≥–¥–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏–π `syscall` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∞–π–ª–æ–≤—ã–π –≤–≤–æ–¥/–≤—ã–≤–æ–¥), –ø–æ—Ç–æ–∫ –û–° `M` –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ:

1. `P` *–æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç—Å—è* –æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ `M` (`handoff()` –≤ `runtime/proc.go`).
2. `P` –Ω–∞—á–∏–Ω–∞–µ—Ç –∏—Å–∫–∞—Ç—å –Ω–æ–≤—ã–π `M`. –ï—Å–ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö `M` –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –û–°.
3. –ö–æ–≥–¥–∞ `syscall` –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è, `M` **–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Å–≤–æ–µ–º—É `P`**, –∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω—É –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å.
4. `M` –ª–∏–±–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É, –ª–∏–±–æ –±–µ—Ä–µ—Ç –Ω–æ–≤—É—é –≥–æ—Ä—É—Ç–∏–Ω—É, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–π `P`.



`sysmon` ‚Äî —ç—Ç–æ **—Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –≤ Go**, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á:

1. **–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç `M`, –∑–∞–≤–∏—Å—à–∏–µ –≤ `syscall`**
   
   - –ï—Å–ª–∏ `M` –∑–∞–≤–∏—Å –≤ `syscall` >10ms, `sysmon` **–∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π `M`**, —á—Ç–æ–±—ã `P` –Ω–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–ª.
   - –ö–æ–≥–¥–∞ `syscall` –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è, `G` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å, –∞ `M` –ª–∏–±–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ª–∏–±–æ –ø–∞—Ä–∫—É–µ—Ç—Å—è.

2. **–û–±—Å–ª—É–∂–∏–≤–∞–µ—Ç `NetPoller`**
   
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ I/O** (`net`, `epoll`, `kqueue`, `IOCP` –¥–ª—è Windows).

3. **–ü—Ä–æ–±—É–∂–¥–∞–µ—Ç `P`, –µ—Å–ª–∏ –æ–Ω –¥–æ–ª–≥–æ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–µ—Ç**
   
   - –ï—Å–ª–∏ `P` –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–ª >10ms, `sysmon` **–¥–∞—ë—Ç –µ–º—É —Ä–∞–±–æ—Ç—É –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏**.

4. **–ó–∞–ø—É—Å–∫–∞–µ—Ç `forcegc` (—Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π GC)**
   
   - –ï—Å–ª–∏ –≥–æ—Ä—É—Ç–∏–Ω—ã –¥–æ–ª–≥–æ –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ `runtime.GC()`, `sysmon` –∑–∞–ø—É—Å–∫–∞–µ—Ç –µ–≥–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.

### –£ `syscall` –µ—Å—Ç—å —Å–≤–æ—è –æ—á–µ—Ä–µ–¥—å?

–ù–µ—Ç, —É `syscall` –Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏. –ù–æ –µ—Å—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ –æ—á–µ—Ä–µ–¥—å:

1. –ö–æ–≥–¥–∞ `syscall` –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è, –µ–≥–æ `M` **–ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ "ready"**.
2. `M` —Å—Ç–∞–≤–∏—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≥–æ—Ä—É—Ç–∏–Ω—É –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –µ–µ –ø–µ—Ä–≤–æ–º—É —Å–≤–æ–±–æ–¥–Ω–æ–º—É `P`.
3. –ï—Å–ª–∏ `M` –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ —Ä–∞–±–æ—Ç—ã, –æ–Ω –ª–∏–±–æ —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è (`exit0()`), –ª–∏–±–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è (`park()`).



### Netpoller

**NetPoller** (–Ω–∞ –±–∞–∑–µ `epoll/kqueue`) –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Ç–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –æ–Ω –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≥–æ—Ä—É—Ç–∏–Ω—ã.

–ö–æ–≥–¥–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ, –∏–º–µ–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —Ç–æ, —á—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è **network poller**, –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞. –≠—Ç–æ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é **epoll** (Linux), kqueue (MacOS), –∏–ª–∏ iocp (Windows) –≤ —ç—Ç–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –û–°.

–°–µ—Ç–µ–≤—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –º–Ω–æ–≥–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–≥–æ–¥–Ω—è. –ò–º–µ–Ω–Ω–æ –∑–¥–µ—Å—å **network poller** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ–±—è, –ø–æ—Å–∫–æ–ª—å–∫—É –µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –ò—Å–ø–æ–ª—å–∑—É—è **network poller** –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–æ–∂–µ—Ç –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≥–æ—Ä—É—Ç–∏–Ω–∞–º –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å **M** –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —ç—Ç–∏—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –¥–µ—Ä–∂–∞—Ç—å **M** –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –≥–æ—Ä—É—Ç–∏–Ω –≤ **LRQ** **P** –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ **M**. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –û–°.

#### –ö–∞–∫ `NetPoller` —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ñ–æ–Ω–µ `syscall`?

`NetPoller` (`runtime.netpoll`) –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ (epoll/kqueue/iocp). –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –Ω–∏–º –∏ –æ–±—ã—á–Ω—ã–º `syscall`:

- –ï—Å–ª–∏ –≥–æ—Ä—É—Ç–∏–Ω–∞ –¥–µ–ª–∞–µ—Ç **—Å–µ—Ç–µ–≤–æ–π –≤—ã–∑–æ–≤**, NetPoller **–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç `M`**, –∞ –ø—Ä–æ—Å—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç `G`.
- –ö–æ–≥–¥–∞ —Å–æ–±—ã—Ç–∏–µ –≥–æ—Ç–æ–≤–æ, `NetPoller` –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω—É –∏ —Å—Ç–∞–≤–∏—Ç –µ–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å.

–ü—Ä–∏–º–µ—Ä:

- `G1` –∂–¥–µ—Ç —Å–æ–∫–µ—Ç (`read()`), `NetPoller` –±–µ—Ä–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ **–æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç `M`**.
- `M` –±–µ—Ä–µ—Ç –¥—Ä—É–≥—É—é `G2`, –Ω–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–µ—Ç.
- –ö–æ–≥–¥–∞ `G1` –≥–æ—Ç–æ–≤–∞, `NetPoller` —Å—Ç–∞–≤–∏—Ç –µ–µ –≤ –æ—á–µ—Ä–µ–¥—å (–≥–ª–æ–±–∞–ª—å–Ω—É—é –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—É—é `P`).

–≠—Ç–æ —Å–∏–ª—å–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ `M`, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.



### **–°–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω (`G`):**

–ì–æ—Ä—É—Ç–∏–Ω–∞ (`G`) –≤ Go –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π:

| **–°–æ—Å—Ç–æ—è–Ω–∏–µ** | **–û–ø–∏—Å–∞–Ω–∏–µ**                                                               |
| ------------- | -------------------------------------------------------------------------- |
| `_Gidle`      | –ì–æ—Ä—É—Ç–∏–Ω–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–æ–±—ã—á–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è).                        |
| `_Grunnable`  | –ì–æ—Ä—É—Ç–∏–Ω–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é, –Ω–æ –∂–¥—ë—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ `P`.                       |
| `_Grunning`   | –ì–æ—Ä—É—Ç–∏–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ `M`.                                               |
| `_Gsyscall`   | –ì–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –≤ `syscall` (–æ–∂–∏–¥–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞). |
| `_Gwaiting`   | –ì–æ—Ä—É—Ç–∏–Ω–∞ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `channel`, `mutex`, `timer`).          |
| `_Gdead`      | –ì–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –∏ –∂–¥—ë—Ç —Å–±–æ—Ä—â–∏–∫–∞ –º—É—Å–æ—Ä–∞.                               |
| `_Gcopystack` | –ì–æ—Ä—É—Ç–∏–Ω–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∏–ª–∏ —É–º–µ–Ω—å—à–∞–µ—Ç —Å—Ç–µ–∫.                                   |
| `_Gscan`      | –ì–æ—Ä—É—Ç–∏–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ GC-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ).                 |

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–∏–Ω–∞–º–∏–∫–µ?**

1. –ì–æ—Ä—É—Ç–∏–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è (`newproc()`) –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **`_Grunnable`**.
2. `P` —Å—Ç–∞–≤–∏—Ç –µ—ë –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å.
3. `M` –∑–∞–±–∏—Ä–∞–µ—Ç –µ—ë –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç ‚Üí **`_Grunning`**.
4. –ï—Å–ª–∏ `G` –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è (`syscall`, –æ–∂–∏–¥–∞–Ω–∏–µ `chan` –∏ —Ç. –¥.) ‚Üí **`_Gsyscall` –∏–ª–∏ `_Gwaiting`**.
5. –ö–æ–≥–¥–∞ `syscall` –∏–ª–∏ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è ‚Üí –≥–æ—Ä—É—Ç–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ **`_Grunnable`**.
6. –ï—Å–ª–∏ –≥–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å ‚Üí **`_Gdead`**, –∏ –ø–∞–º—è—Ç—å –ø–æ–¥ –Ω–µ—ë —á–∏—Å—Ç–∏—Ç GC.



### **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `park()`?**

–§—É–Ω–∫—Ü–∏—è `park()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ–±—ã **–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫ –û–° (`M`)**, –µ—Å–ª–∏ –æ–Ω –Ω–µ –Ω—É–∂–µ–Ω.

üîπ **–ö–æ–≥–¥–∞ `M` –ø–∞—Ä–∫—É–µ—Ç—Å—è?**

- –ï—Å–ª–∏ `P` —Å—Ç–∞–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º (–Ω–µ—Ç `G` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è).
- –ï—Å–ª–∏ `P` –±—ã–ª –æ—Ç–≤—è–∑–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ `syscall`).
- –ï—Å–ª–∏ `GOMAXPROCS` —É–º–µ–Ω—å—à–∏–ª—Å—è, –∏ `M` –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω.

üîπ **–ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç?**

1. `M` –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ —É –Ω–µ–≥–æ –Ω–µ—Ç —Ä–∞–±–æ—Ç—ã.
2. `M` –≤—ã–∑—ã–≤–∞–µ—Ç `park()`, –æ—Å–≤–æ–±–æ–∂–¥–∞—è —Ä–µ—Å—É—Ä—Å—ã –û–°.
3. –ï—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞, `P` —Ä–∞–∑–±—É–¥–∏—Ç `M` —á–µ—Ä–µ–∑ `runtime.notewakeup()`.



### **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `handoff()`?**

–§—É–Ω–∫—Ü–∏—è `handoff()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ–±—ã **–ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å `P` –¥—Ä—É–≥–æ–º—É `M`**, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π `M` –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª—Å—è (`syscall`).

üîπ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

1. `G1` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ `M1` (–ø—Ä–∏–≤—è–∑–∞–Ω –∫ `P1`).
2. `G1` –≤—ã–∑—ã–≤–∞–µ—Ç `syscall`, `M1` –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è (`_Gsyscall`).
3. `handoff()` **–æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç `P1` –æ—Ç `M1`** –∏ –¥–∞—ë—Ç –µ–≥–æ –¥—Ä—É–≥–æ–º—É `M2`.
4. `M2` —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω—ã `P1`.
5. –ö–æ–≥–¥–∞ `syscall` –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è, `M1` –æ—Ç–ø—Ä–∞–≤–∏—Ç `G1` –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å.

üîπ **–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?**  
–ë–µ–∑ `handoff()` `P` –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–ª –±—ã, –ø–æ–∫–∞ `M` –∂–¥—ë—Ç `syscall`. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ `P` —Å—Ä–∞–∑—É –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–º `M`.



### **–ö—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –≥–æ—Ä—É—Ç–∏–Ω—É?**

–ì–æ—Ä—É—Ç–∏–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é `go func()`, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç `runtime.newproc()`.

üîπ **–ê–ª–≥–æ—Ä–∏—Ç–º `newproc()`:**

1. **–ë–µ—Ä—ë—Ç `P` —Ç–µ–∫—É—â–µ–≥–æ `M`**, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `go func()`.
2. **–í—ã–¥–µ–ª—è–µ—Ç –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç `G`**, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ —Å—Ç–µ–∫ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
3. **–î–æ–±–∞–≤–ª—è–µ—Ç `G` –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å `P`**, –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ.
4. –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å `P` –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (256 `G`), **–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ `G` —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å**.



*–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:*

- https://habr.com/ru/users/not91/publications/articles/

- https://habr.com/ru/articles/333654/

- https://habr.com/ru/articles/502506/